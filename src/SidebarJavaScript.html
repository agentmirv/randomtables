<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/1.0.11/jsrender.min.js" integrity="sha512-bKlNlbTH3duwZ28zoqEhXui/yuaPuQVci6OAVu0zh2WfYbEKD39HszVR8byP4/L4YyBo3b5CGIY+4ldVN93uCg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
  $(function () {

    $("#sidebar-container").on("container:append", function (event, sectionData) {
      var template = $.templates("#sidebarSectionTemplate");
      var htmlOutput = template.render(sectionData.sections);
      $("#sidebar-container").html(htmlOutput);      

    }).on("click", ".sidebar-section-close", function () {
      $(this).closest( ".sidebar-section" ).remove();

    }).on("click", ".sidebar-section-toggle", function () {
      $(this).closest( ".sidebar-section" ).find('.sidebar-section-container').toggle();
      
    }).on("click", "button[data-id]", function () {
      var button = $(this);
      button.prop('disabled', true);
      var data_url = button.attr('data-url');
      var data_id = button.attr('data-id');

      google.script.run
        .withSuccessHandler(
          function () {
            button.prop('disabled', false);
            showStatus('');
          })
        .withFailureHandler(
          function (msg, element) {
            // Respond to failure conditions here.
            button.prop('disabled', false);
            showStatus(msg, 'error');
            element.disabled = false;
          })
        .handleSectionButtonClick(data_url, data_id);
    });

    $("#sidebar-container").sortable({
      handle: ".sidebar-section-title",
      axis: "y"
    });

    $("#sidebar-load-button").click(function () {
      var button = $(this);
      button.prop('disabled', true);
      var url = $("#sidebar-load-url").val();

      google.script.run
        .withSuccessHandler(
          function (data) {
            $("#sidebar-container").trigger("container:append", data);
            button.prop('disabled', false);
            showStatus('');
          })
        .withFailureHandler(
          function (msg, element) {
            // Respond to failure conditions here.
            button.prop('disabled', false);
            showStatus(msg, 'error');
            element.disabled = false;
          })
        .handleLoadButton(url);
    });
    
    $("#sidebar-load-button").trigger("click");
  });

  /**
   * Displays the given status message in the sidebar.
   *
   * @param {String} msg The status message to display.
   * @param {String} classId The message type (class id) that the message
   *   should be displayed as.
   */
  function showStatus(msg, classId) {
    $('#sidebar-status').removeClass().html(msg);
    if (classId) {
      $('#sidebar-status').addClass(classId);
    }
  }

</script>