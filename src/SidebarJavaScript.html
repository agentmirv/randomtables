<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsviews/1.0.11/jsviews.min.js" integrity="sha512-nzeptB37xiXMYfCfY/IF7iDG13S82taErKCx2+bIWukARqZNu7Gea6W7/VYf5FerrcIpfB5RkrjR9hEyvLtO9A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://www.jsviews.com/download/sample-tag-controls/jsviews-jqueryui-widgets.min.js"></script>

<script>
  $.views.viewModels({
    Sidebar: {
      getters: [
      "randomTablesUrl", 
      "disableButton",
      "statusMessage",
      "isError",
      { getter: "sections", type: "Section" },
      ],
      // extend: {addPhone: addPhone}
    },
    Section: {
      getters: [
        "url",
        "name",
        "isError",
        "isLoaded",
        "isMinimized",
        "msg",
        { getter: "buttons", type: "Button" },
      ]
    },
    Button: {
      getters: [
        "name",
        "outputRange",
        "inputCount",
        "inputRange",
      ]
    },
  });  
</script>
<script>
  var helpers = {
    //=================================
    // handleInitialize -> handleInitialize
    //=================================
    handleInitialize: function(sidebar) {
      var helper = this;
      sidebar.disableButton(true);
      google.script.run
        .withUserObject(sidebar)
        .withSuccessHandler(
          function (url, userObject) {
            userObject.randomTablesUrl(url);
            userObject.disableButton(false);
            userObject.statusMessage("");
            userObject.isError(false);
            helper.loadRandomTablesUrl(userObject);
          })
        .withFailureHandler(
          function (msg, userObject) {
            userObject.disableButton(false);
            userObject.statusMessage(msg);
            userObject.isError(true);
          })
        .handleInitialize();
    },
    //=================================
    // handleLoadButton -> loadRandomTablesUrl
    //=================================
    handleLoadButton: function(ev, eventArgs) {
      var sidebar = eventArgs.view.data;
      this.loadRandomTablesUrl(sidebar);
    },
    //=================================
    // loadRandomTablesUrl -> handleLoadButton
    //=================================
    loadRandomTablesUrl: function(sidebar) {
      sidebar.disableButton(true);
      google.script.run
        .withUserObject(sidebar)
        .withSuccessHandler(
          function (sections, userObject) {
            for (let i = 0; i < sections.length; i++){
              $.observable(userObject.sections()).insert($.views.viewModels.Section.map(sections[i]));
            } 
            userObject.disableButton(false);
            userObject.statusMessage("");
            userObject.isError(false);
          })
        .withFailureHandler(
          function (msg, userObject) {
            userObject.disableButton(false);
            userObject.statusMessage(msg);
            userObject.isError(true);
          })
        .handleLoadButton(sidebar.randomTablesUrl());
    },
    //=================================
    // handleLoadSection -> handleLoadSection
    //=================================
    handleLoadSection: function(ev, eventArgs) {
      if (eventArgs.change == "insert") {
        var sectionData = eventArgs.items[0];
        google.script.run
          .withUserObject(sectionData)
          .withSuccessHandler(
            function (section, userObject) {
              userObject.name(section.name);
              userObject.url(section.url);
              userObject.buttons($.views.viewModels.Button.map(section.buttons))
              userObject.isLoaded(true);
            })
          .withFailureHandler(
            function (msg, userObject) {
              userObject.msg(msg);
              userObject.isError(true);
            })
          .handleLoadSection(sectionData.url());
      }
    },
    //=================================
    // handleMinimize
    //=================================
    handleMinimize: function(ev, eventArgs) {
      var sectionData = eventArgs.view.data;
      sectionData.isMinimized(!sectionData.isMinimized());
    },
    //=================================
    // handleRemove
    //=================================
    handleRemove: function(ev, eventArgs) {
      var sidebarData = eventArgs.view.root.data;
      var sectionIndex = eventArgs.view.getIndex();
      $.observable(sidebarData.sections()).remove(sectionIndex);
    },
    //=================================
    // handleAction -> handleAction
    //=================================
    handleAction: function(ev, eventArgs) {
      var actionData = eventArgs.view.data;
      var sectionData = eventArgs.view.parent.parent.data;
      var sidebarData = eventArgs.view.root.data; 
      var url = sectionData.url()
      var name = actionData.name();
      var outputRange = actionData.outputRange(); 
      var inputCount = actionData.inputCount();
      var inputRange = actionData.inputRange();
      google.script.run
        .withUserObject(sidebarData)
        .withSuccessHandler(
          function (returnValue, userObject) {
            userObject.statusMessage("");
            userObject.isError(false);
          })
        .withFailureHandler(
          function (msg, userObject) {
            userObject.statusMessage(msg);
            userObject.isError(true);
          })
        .handleAction(url, name, outputRange, inputCount, inputRange);
    },
  };
</script>
<script>
  var sidebar = $.views.viewModels.Sidebar.map({ sections: [] });

  $.views.helpers({ sidebarHelper: helpers });

  $.templates("loadTemplate", "#sidebar-load-bar-template");
  $.templates("statusTemplate", "#sidebar-status-template");
  $.templates("sectionTemplate", "#sidebar-section-template");

  $.link.loadTemplate("#sidebar-load-bar", sidebar);
  $.link.statusTemplate("#sidebar-status", sidebar);
  $.link.sectionTemplate("#sidebar-container", sidebar);

  $.observe(sidebar.sections(), helpers.handleLoadSection);

  helpers.handleInitialize(sidebar);
</script>
