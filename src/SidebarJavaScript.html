<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsviews/1.0.11/jsviews.min.js" integrity="sha512-nzeptB37xiXMYfCfY/IF7iDG13S82taErKCx2+bIWukARqZNu7Gea6W7/VYf5FerrcIpfB5RkrjR9hEyvLtO9A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://www.jsviews.com/download/sample-tag-controls/jsviews-jqueryui-widgets.min.js"></script>

<script>
  var helpers = {
    //=================================
    // handleInitialize -> handleInitialize
    //=================================
    handleInitialize: function(data) {
      google.script.run
        .withUserObject(data)
        .withSuccessHandler(
          function (url, userObject) {
            $.observable(userObject).setProperty("randomTablesUrl", url);
            $.observable(userObject).setProperty("disableButton", false);
            $.observable(userObject).setProperty("statusMessage", "");
            $.observable(userObject).setProperty("isError", false);
          })
        .withFailureHandler(
          function (msg, userObject) {
            $.observable(userObject).setProperty("disableButton", false);
            $.observable(userObject).setProperty("statusMessage", msg);
            $.observable(userObject).setProperty("isError", true);
          })
        .handleInitialize();
    },
    //=================================
    // loadUrl -> handleLoadButton
    //=================================
    handleLoadButton: function(ev, eventArgs) {
      var data = eventArgs.view.data;
      $.observable(data).setProperty("disableButton", true);
      google.script.run
        .withUserObject(data)
        .withSuccessHandler(
          function (sections, userObject) {
            for (let i = 0; i < sections.length; i++){
              $.observable(userObject.sections).insert(sections[i]);
            } 
            $.observable(userObject).setProperty("disableButton", false);
            $.observable(userObject).setProperty("statusMessage", "");
            $.observable(userObject).setProperty("isError", false);
          })
        .withFailureHandler(
          function (msg, userObject) {
            $.observable(userObject).setProperty("disableButton", false);
            $.observable(userObject).setProperty("statusMessage", msg);
            $.observable(userObject).setProperty("isError", true);
          })
        .handleLoadButton(data.randomTablesUrl);
    },
    //=================================
    // handleLoadSection -> handleLoadSection
    //=================================
    handleLoadSection: function(ev, eventArgs) {
      if (eventArgs.change == "insert") {
        var sectionData = eventArgs.items[0];
        google.script.run
          .withUserObject(sectionData)
          .withSuccessHandler(
            function (section, userObject) {
              $.observable(userObject).setProperty("name", section.name);
              $.observable(userObject).setProperty("url", section.url);
              $.observable(userObject).setProperty("buttons", section.buttons);
              $.observable(userObject).setProperty("isLoaded", true);
            })
          .withFailureHandler(
            function (msg, userObject) {
              $.observable(userObject).setProperty("msg", msg);
              $.observable(userObject).setProperty("isError", true);
            })
          .handleLoadSection(sectionData.url);
      }
    },
    //=================================
    // handleMinimize
    //=================================
    handleMinimize: function(ev, eventArgs) {
      $.observable(eventArgs.view.data).setProperty("isMinimized", !eventArgs.view.data.isMinimized);
    },
    //=================================
    // handleRemove
    //=================================
    handleRemove: function(ev, eventArgs) {
      var view = $.view(ev.target);
      var index = $.view(ev.target).getIndex();
      var sections = view.get('array').data;
      $.observable(sections).remove(index);
    },
    //=================================
    // handleAction -> handleAction
    //=================================
    handleAction: function(ev, eventArgs) {
      var url = eventArgs.view.parent.parent.data.url
      var name = eventArgs.view.data.name;
      var outputRange = eventArgs.view.data.outputRange; 
      var inputCount = eventArgs.view.data.inputCount;
      var inputRange = eventArgs.view.data.inputRange;
      var data = eventArgs.view.root.data
      google.script.run
        .withUserObject(data)
        .withSuccessHandler(
          function (userObject) {
            $.observable(userObject).setProperty("statusMessage", "");
            $.observable(userObject).setProperty("isError", false);
          })
        .withFailureHandler(
          function (msg, userObject) {
            $.observable(userObject).setProperty("statusMessage", msg);
            $.observable(userObject).setProperty("isError", true);
          })
        .handleAction(url, name, inputCount, inputRange);
    },
    //=================================
    // showDialog -> showDialog
    //=================================
    showDialog: function(ev, eventArgs) {
      var url = eventArgs.view.parent.parent.data.url
      var name = eventArgs.view.data.name;
      var outputRange = eventArgs.view.data.outputRange;
      var inputCount = eventArgs.view.data.inputCount;
      var inputRange = eventArgs.view.data.inputRange;
      var data = eventArgs.view.root.data
      google.script.run
        .withUserObject(data)
        .withSuccessHandler(
          function (userObject) {
            $.observable(userObject).setProperty("statusMessage", "");
            $.observable(userObject).setProperty("isError", false);
          })
        .withFailureHandler(
          function (msg, userObject) {
            $.observable(userObject).setProperty("statusMessage", msg);
            $.observable(userObject).setProperty("isError", true);
          })
        .showDialog(url, name, outputRange, inputCount, inputRange);
    },
  };
  
  var loadTemplate = $.templates("#sidebar-load-bar-template");
  loadTemplate.link("#sidebar-load-bar", data, helpers);

  var statusTemplate = $.templates("#sidebar-status-template");
  statusTemplate.link("#sidebar-status", data, helpers);

  var sectionTemplate = $.templates("#sidebar-section-template");
  sectionTemplate.link("#sidebar-container", data, helpers);

  $.observe(data, "sections", helpers.handleLoadSection);

  helpers.handleInitialize(data);
</script>
